<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Jogo - Votação</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="style.css">
        <link rel="shortcut icon" href="img/mini-logo.png" type="image/x-icon">
        <script src="https://kit.fontawesome.com/8b0455432d.js" crossorigin="anonymous"></script>
    </head>
<body>

    <div id="resultado"><p id="resultadoP">

    </p></div>
    
    <div class="navegacao">
        <a href="noite.html"><button class="botao-conteudo" id="salvar-sessao">Continuar</button></a>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    function atualizarStatusJogador(nomeJogador, novoStatus) {
        const jogadoresStatus = JSON.parse(localStorage.getItem('jogadoresStatus')) || [];
        const jogadorIndex = jogadoresStatus.findIndex(jogador => jogador.nome === nomeJogador);

        if (jogadorIndex !== -1) {
            jogadoresStatus[jogadorIndex].status = novoStatus;
            localStorage.setItem('jogadoresStatus', JSON.stringify(jogadoresStatus));
            console.log(`Status do jogador "${nomeJogador}" atualizado para "${novoStatus}".`);
        } else {
            console.warn(`Jogador "${nomeJogador}" não encontrado na lista.`);
        }
    }
    const resultadoSorteio = JSON.parse(localStorage.getItem('resultadoSorteio')) || [];

    const jogadoresStatus = JSON.parse(localStorage.getItem('jogadoresStatus')) || [];
    const votos = JSON.parse(localStorage.getItem('votacao')) || {};
    let maxVotos = 0;
    let jogadoresComMaxVotos = [];

    for (let jogador in votos) {
        if (votos[jogador] > maxVotos) {
            maxVotos = votos[jogador];
            jogadoresComMaxVotos = [jogador];
        } else if (votos[jogador] === maxVotos) {
            jogadoresComMaxVotos.push(jogador);
        }
    }

    const resultadoP = document.getElementById('resultadoP');
    const principeJogadores = JSON.parse(localStorage.getItem('principe')) || [];

    if (jogadoresComMaxVotos.length > 1) {
        resultadoP.textContent = 'Votos empatados! Ninguém morreu.';
    } else if (jogadoresComMaxVotos.length === 1) {
        const vencedor = jogadoresComMaxVotos[0];

        const jogadoresStatus = JSON.parse(localStorage.getItem('jogadoresStatus')) || [];
        const jogadorStatus = resultadoSorteio.find(jogador => jogador.jogador === vencedor);
        
        let principeJogadores = JSON.parse(localStorage.getItem('principe')) || [];
        localStorage.setItem('principe', JSON.stringify(principeJogadores));


        if (jogadorStatus && jogadorStatus.papel === 'príncipe bonitão' && !principeJogadores.includes(vencedor)) {
            
            resultadoP.textContent = `${vencedor} é um Príncipe Bonitão e não morrerá dessa vez.`;
            principeJogadores.push(vencedor);
            localStorage.setItem('principe', JSON.stringify(principeJogadores));
        } else {            
            alert('2')

            atualizarStatusJogador(vencedor, 'morto');
            resultadoP.textContent = `${vencedor} recebeu ${maxVotos} voto(s) e morreu pela vila.`;
        }
    } else {
        resultadoP.textContent = 'Não houve votação.';
    }

    localStorage.removeItem('votacao');
    localStorage.removeItem('ordemDeVotacao');

    const jogadores = JSON.parse(localStorage.getItem('jogadores')) || [];
    
    const vivos = jogadoresStatus.filter(jogador => jogador.status === 'vivo');
    const mortos = jogadoresStatus.filter(jogador => jogador.status === 'morto');

    const lobisomensVivos = resultadoSorteio
        .filter(jogador => jogador.papel === 'lobisomem' && vivos.some(v => v.nome === jogador.jogador));
    const aldeoesVivos = resultadoSorteio
        .filter(jogador => jogador.papel !== 'lobisomem' && vivos.some(v => v.nome === jogador.jogador));

    const vilaVence = lobisomensVivos.length === 0;
    const lobisomensVencem = lobisomensVivos.length > aldeoesVivos.length;

    if (vilaVence || lobisomensVencem) {
        const vitoria = {
            vencedores: vilaVence ? "A Vila" : "Os Lobisomens",
            vivos: vivos.map(j => j.nome),
            mortos: mortos.map(j => j.nome),
            papeis: resultadoSorteio.map(j => ({ jogador: j.jogador, papel: j.papel }))
        };

        localStorage.setItem('vitoria', JSON.stringify(vitoria));

        window.location.href = 'vitoria.html';
    }
});
    </script>
</body>
</html>
